---
title: "Interaction Identification and Estimation using Data-Adaptive Stochastic Interventions"
author: "David McCoy"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: ../inst/references.bib
vignette: >
  %\VignetteIndexEntry{Interaction Identification and Estimation using Data-Adaptive Stochastic Interventions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r libraries, warning=FALSE}
library(InterXshift)
library(devtools)
library(kableExtra)
library(sl3)

seed <- 429153
set.seed(seed)
```

## Motivation 

The motivation behind the package InterXshift is to address the limitations of traditional statistical methods in environmental epidemiology studies. Analysts are often interested in understanding the joint impact of a mixed exposure, i.e. a vector of exposures, but the most important exposures and exposure sets remain unknown. Traditional methods make overly simplistic assumptions, such as linear and additive relationships, and the resulting statistical quantities may not be directly applicable to public policy decisions. More flexible methods offer dose response relationships but do not result in an easily interpretable estimate. Here, we utilize cross-validated targeted learning with stochastic shift interventions to identify exposures in a mixture that have the strongest positive and negative effect. We also define interaction as a comparison of the expected outcome under joint shift to additive shifts. With this definition we identify the top synergistic and antagonistic relationships and provide efficient estimates of stochastic shift interventions. 


## Target Parameter 

InterXshift uses data-adaptive machine learning methods to identify the exposures and exposure sets that have the most synergy or antagonism. This is defined based on our target parameter: 

$$
\begin{align}
    \Psi_{\text{IE}} = &E[Y | A_i + \delta_i, A_j + \delta_j, \mathbf{A}_{- i,j}, W] \nonumber \\
              &- \big(E[Y | A_i + \delta_i, \mathbf{A}_{- i}, W] + E[Y | A_j + \delta_j, \mathbf{A}_{- j}, W]\big) \nonumber \\
              &+ E[Y]
  \end{align}

$$

Which measures the expected outcome under a shift of two exposures to the sum of their individual impacts. The exposure sets with the largest positive values have synergy meaning their joint impact is more than additive. The exposure sets with the largest negative value have the most antagonism. 

## G-computation Approximation

To identify the most synergistic and antagonistic exposure sets we employ a g-computation framework. We first construct a super learner, or ensemble of machine learning algorithms. We then construct all two-way combinations and for each combination calculate our interaction. We rank these results and select the top positive and negative results which represent synergy and antagonism. 


## Sample Splitting 

Because we don't know which exposure sets to estimate our interaction parameter on a priori, we need to split our data and in the training fold find the exposure sets, using the above g-computation framework, and in an estimation sample, efficiently estimate the interaction parameter for these exposure sets so that we can get valid confidence intervals for these data-adaptively identified interactions. This is done using targeted learning.


## Targeted Learning

We use targeted minimum loss based estimation (TMLE) to debias our initial outcome estimates given a shift in exposure such that the resulting estimator is asymptotically unbiased and has the smallest variance. This procedure involves constructing a least favorable submodel which uses a ratio of conditional exposure densities under shift and now shift as a covariate to debias the initial estimates. More details of targeted learning for stochastic shifts are here @diaz2012population


## Data Adaptive Delta

For each exposure, the user inputs a respective delta, for example for exposures $M1, M2, M3$ the analyst puts in the `deltas` vector 

```{r deltas, message=FALSE, warning=FALSE}
deltas <- c("M1" = 1, "M2" = 2.3, "M3" = 1.4)
```

Which assigns a delta shift amount to each exposure. However, because the user doesn't know the underlying experimentation in the data, a delta that is too big may result in positivity violations which leads to bias and high variance of the estimator. That is, if the user asks for a shift in exposure density that is very unlikely given the data. To solve this, the analyst can also choose to set `adaptive_delta = TRUE` which then makes the shift amount a data adaptive parameter as well. The delta will be reduced until the max of the ratio of densities for each exposure is less than or equal to `hn_trunc_thresh`.

## Inputs and Outputs 

InterXshift takes in covariates, exposures, an outcome, a list of deltas to shift each exposure by, the estimator (tmle or one step) number of folds for the CV procedure, parallelization parameters and if the delta should be data-adaptive. Also the user defines top_n which is the number of ranked synergistic, antagonistic and individual positive and negative effects to extract from the mixed exposure.

The package then outputs K-fold specific results, the result found in each fold, and the oracle result which is the parameter that is pooled across all the folds. For example, we will get the fold specific synergy results for the rank 1 and rank 2 exposure sets found to have the highest expectation under joint shift compared to positive shift. The pooled parameter is the oracle rank 1, meaning we do a pooled TMLE for all the rank 1 findings across the folds. The same is true for the other parameters. 


We get pooled rank synergy, antagonism, positive and negative effects. If the same exposure sets are used across the folds, the pooled estimate is interpretable and has greater power compared to k-fold. If not, the analyst must investigate the k-fold specific results and report consistency of findings. 

## NHANES Data

Here we will try and replicate the analysis by Gibson et. al.:

https://ehjournal.biomedcentral.com/articles/10.1186/s12940-019-0515-1

and Mitro et. al, 
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4858394/

Who used the NHANES 2001-2002 data to investigate 18 POP exposures on telomere length. 

Let's first load the data and investigate the variables: 


```{r NHANES data and variables}
data("NHANES_eurocim")

exposures <- c("LBX074LA", # PCB74 Lipid Adj (ng/g)
               "LBX099LA", # PCB99 Lipid Adj (ng/g)
               "LBX118LA", # PCB118 Lipid Adj (ng/g)
               "LBX138LA", # PCB138 Lipid Adj (ng/g)
               "LBX153LA", # PCB153 Lipid Adj (ng/g)
               "LBX170LA", # PCB170 Lipid Adj (ng/g)
               "LBX180LA", # PCB180 Lipid Adj (ng/g)
               "LBX187LA", # PCB187 Lipid Adj (ng/g)
               "LBX194LA", # PCB194 Lipid Adj (ng/g)
               "LBXD03LA", # 1,2,3,6,7,8-hxcdd Lipid Adj (pg/g)
               "LBXD05LA", # 1,2,3,4,6,7,8-hpcdd Lipid Adj (pg/g)
               "LBXD07LA", # 1,2,3,4,6,7,8,9-ocdd Lipid Adj (pg/g)
               "LBXF03LA", # 2,3,4,7,8-pncdf Lipid Adj (pg/g)
               "LBXF04LA", # 1,2,3,4,7,8-hxcdf Lipid Adj (pg/g)
               "LBXF05LA", # 1,2,3,6,7,8-hxcdf Lipid Adj (pg/g)
               "LBXF08LA", # 1,2,3,4,6,7,8-hxcdf Lipid Adj (pg/g)
               "LBXHXCLA", # 3,3',4,4',5,5'-hxcb Lipid Adj (pg/g)
               "LBXPCBLA") # 3,3',4,4',5-pcnb Lipid Adj (pg/g)

NHANES_eurocim <- NHANES_eurocim[complete.cases(NHANES_eurocim[, exposures]), ]

outcome <- "TELOMEAN"

covariates <- c("LBXWBCSI", # White blood cell count (SI)
                "LBXLYPCT", # Lymphocyte percent (%)
                "LBXMOPCT", # Monocyte percent (%)
                "LBXEOPCT", # Eosinophils percent (%)
                "LBXBAPCT", # Basophils percent (%)
                "LBXNEPCT", # Segmented neutrophils percent (%)
                "male", # Sex
                "age_cent", # Age at Screening, centered
                "race_cat", # race
                "bmi_cat3", # Body Mass Index (kg/m**2)
                "ln_lbxcot", # Cotinine (ng/mL), log-transformed
                "edu_cat") # Education Level - Adults 20+


```

To improve consistency in the region we find to be the maximizing region, it is best to remove an exposure of highly correlated sets, we do that here: 

```{r remove correlated exposures}
# Calculate the correlation matrix for the exposures
cor_matrix <- cor(NHANES_eurocim[, exposures], use = "complete.obs")

# Set a threshold for high correlation
threshold <- 0.8

# Find pairs of highly correlated exposures
highly_correlated_pairs <- which(abs(cor_matrix) > threshold & lower.tri(cor_matrix), arr.ind = TRUE)

# Initiate a vector to keep track of exposures to remove
exposures_to_remove <- c()

# Loop through the highly correlated pairs and decide which exposure to remove
for (pair in seq_len(nrow(highly_correlated_pairs))) {
  row <- highly_correlated_pairs[pair, "row"]
  col <- highly_correlated_pairs[pair, "col"]

  if (!(colnames(cor_matrix)[row] %in% exposures_to_remove)) {
    exposures_to_remove <- c(exposures_to_remove, colnames(cor_matrix)[row])
  }
}

# Keep only uncorrelated exposures
exposures_to_keep <- setdiff(exposures, exposures_to_remove)

```


## Run InterXshift 

```{r run InterXshift for NHANES, warning=FALSE, message=FALSE}
deltas <- list(
  "LBX074LA" = 1, "LBX099LA" = 1, "LBXD03LA" = 1,
  "LBXD05LA" = 1, "LBXF03LA" = 1, "LBXF04LA" = 1, "LBXF08LA" = 1, 
  "LBXPCBLA" = 1
)

ptm <- proc.time()

w <- NHANES_eurocim[, covariates]
a <- NHANES_eurocim[, exposures_to_keep]
y <- NHANES_eurocim$TELOMEAN

NIEH_results <- InterXshift(
  w = w,
  a = a,
  y = y,
  deltas = deltas,
  n_folds = 5,
  outcome_type = "continuous",
  parallel = TRUE,
  parallel_type = "multi_session",
  num_cores = 5,
  seed = seed,
  adaptive_delta = FALSE,
  top_n = 1
)

proc.time() - ptm
```


## Investigating Results

One note is that for this example we will get more variability than normal because we only run 3 fold CV due to computational time. 

Let's first look at the results for each fold: 


```{r positive results, eval = TRUE}
NIEH_results$`Pos Shift Results by Rank` %>%
  kableExtra::kbl(caption = "Top Positive Effects") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```
Here we see LBXF03LA is found in all the folds for the top positive effects. Estimates under Psi indicate the change in expected outcome under a 1-unit intervention compared to the mean outcome under the observed exposure distribution. Fold is the fold number estimates are being made for and the last column is the pooled TMLE estimate for all of our rank 1 estimates. Variance is estimated from the influence function for stochastic shift interventions with subsequent standard error and CI estimates. 

N is the number of observations used in the calculation. In the pooled results this should be equal to the total sample size. Here, because we are interested in positive associations, if the associations are significant we expect our Psi estimates to be positive, indicating a shift is greater than the observed mean outcome. 

Users here should look for inconsistencies in the exposure that is found as the top positive effect. Inconsistencies indicate there is not "strong signal" for this estimate and make the pooled rank 1 estimate difficult to interpret. 

```{r negative results, eval = TRUE}
NIEH_results$`Neg Shift Results by Rank` %>%
  kableExtra::kbl(caption = "Top Negative Effects") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

Here is the same type of table but for the top negative results. Output is in the same format as above for the positive results. If the Psi estimates are significant, we expect these effects to be negative. Indicating the shift by 1 unit reduces the expected outcome compared to the observed mean. 


```{r top synergy results, eval = TRUE}
k_fold_synergy <- do.call(rbind, NIEH_results$`K Fold Synergy Results`)

k_fold_synergy %>%
  kableExtra::kbl(caption = "Top Synergy Effects") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

These are now estimates for the top synergistic impact. The format of the table is similar but now we have the Type column which indicates which exposure the shift is for. Where one exposure is listed, that is a univariate shift, where two is listed that is a joint shift and for interaction this is comparing the expectation under joint shift to the sum of the estimates under the univariate shifts. 

If the interaction estimates are significant, we would expect the Psi under interaction to be positive, indicating the joint shift is larger than the sum of individual shifts. Variance estimates are similarly derived from the influence function and delta method. 

```{r top antagonistic results, eval = TRUE}
k_fold_antagonistic <- do.call(rbind, NIEH_results$`K Fold Antagonism Results`)

k_fold_antagonistic %>%
  kableExtra::kbl(caption = "Top Antagonistic Effects") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

This table is formatted in the same way as our synergistic results where we compare joint shifts to individual shifts. Now however, if interaction effects are significant, we expect the joint shift to be less than the sum of individual shifts and therefore the interaction effect should be negative. 

Again, it is important to assess if the same exposures are found in the synergist and antagonistic relationships. If they are, we can interpret the pooled TMLE estimates, here we show our pooled estimates for the antagonistic interaction: 

```{r top pooled antagonistic results, eval = TRUE}

NIEH_results$`Pooled Antagonism Results by Rank` %>%
  kableExtra::kbl(caption = "Pooled Antagonistic Effects") %>%
  kable_classic(full_width = F, html_font = "Cambria")
```

This table is formatted similarly but now instead of having variable names under Type we have Var 1, Var 2, Joint, Interaction. This is because we are pooling estimates for the top antagonistic interaction and the variables used in this interation may differ. If there is consistency across all the folds, Var 1 corresponds to the first variable that is shifted, Var 2 the second, Joint is the joint shift and Interaction is the same comparison. 

Again, if the interaction is significant and results are consistent we would expect this estimate to be negative. By pooling, we are able to leverage the full data which gives us more narrow confidence intervals. 

## Comparing to Previous Findings 

Positive Association 

For a shift of 1 unit in all exposures we found LBXF03LA (2,3,4,7,8-pncdf Lipid Adj (pg/g)) to have the strongest positive association. This matches the penalized regression results of Gibson et. al. Similarly, this chemical had the second highest weight in WQS regression. Using BKMR this chemical showed the highest positive association in the dose-response plots. 

Negative Association 

We found LBXD03LA (1,2,3,6,7,8-hxcdd Lipid Adj (pg/g)) to have the strongest negative association. Which is corroborated by the results from Gibson et al., however there are many null/negative chemical associations. 

Synergy Results 

LBXD03LA-LBXD05LA ((1,2,3,6,7,8-hxcdd - 1,2,3,4,6,7,8-hpcdd) had the most consistency, 3 of 4 folds in this small example. From Gibson, no interactions were found and the other methods did not assess for interactions. None of the interventions were significant here with CI's spanning the range from antagonism to synergy for the interaction effect. For the synergy effect we would expect the joint shift to be larger than the additive effect. 

Antagonistic Results 

LBXF03LA (2,3,4,7,8-pncdf) and LBXF04LA (1,2,3,4,7,8-hxcdf) showed the strongest antagonism and this relationship was found across all the folds. This effect is not significant but what we would expect to see for this result is that the joint shift is less than the additive effect 



